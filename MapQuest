<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GraphHopper</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<!-- Google Font -->
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">

<style>
  body {
    font-family: 'Poppins', sans-serif;
    background-color: #f3fff3;
    color: #0b3d1b;
    margin: 0;
    padding: 0;
  }

  header {
    background-color: #0b7a3a;
    color: #fff;
    text-align: center;
    padding: 16px;
    font-size: 1.6em;
    letter-spacing: 0.5px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  }

  main {
    padding: 20px;
    max-width: 900px;
    margin: auto;
  }

  label {
    font-weight: 500;
  }

  input, select {
    padding: 8px 10px;
    border: 1px solid #b6e0b8;
    border-radius: 6px;
    margin-top: 4px;
    width: 100%;
    font-family: 'Poppins', sans-serif;
    font-size: 15px;
  }

  button {
    background-color: #0b7a3a;
    color: white;
    border: none;
    border-radius: 6px;
    padding: 10px 16px;
    font-size: 15px;
    cursor: pointer;
    font-family: 'Poppins', sans-serif;
    transition: background 0.2s;
  }

  button:hover {
    background-color: #0d8c41;
  }

  #map {
    height: 420px;
    border-radius: 10px;
    margin: 20px 0;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
  }

  h3 {
    color: #0b7a3a;
    margin-top: 25px;
  }

  #directions {
    background-color: #ffffff;
    border: 1px solid #d9efd9;
    border-radius: 10px;
    padding: 10px;
    max-height: 300px;
    overflow-y: auto;
    font-size: 15px;
    line-height: 1.5;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
  }

  .direction-box {
    background-color: #f8fff8;
    border-radius: 8px;
    padding: 8px 10px;
    margin-bottom: 8px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    display: flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
    transition: background 0.2s;
  }

  .direction-box:hover {
    background-color: #e0ffe5;
  }

  .active-step {
    background-color: #c2f7c6 !important;
    border: 1px solid #0b7a3a;
  }

  #logs {
    background: #fff;
    padding: 10px;
    border-radius: 10px;
    font-size: 13px;
    max-height: 150px;
    overflow-y: auto;
    border: 1px solid #d9efd9;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
  }

</style>
</head>
<body>
  <header>üó∫Ô∏è GraphHopper</header>

  <main>
    <label>Mode of travel:</label>
    <select id="vehicle">
      <option value="car">Car</option>
      <option value="bike">Bike</option>
      <option value="foot">Foot</option>
    </select><br><br>

    <label>Start location:</label>
    <input type="text" id="start" placeholder="e.g. Manila"><br><br>

    <label>Destination:</label>
    <input type="text" id="end" placeholder="e.g. Quezon City"><br><br>

    <label><input type="checkbox" id="stepMode"> Step-by-step mode</label>
    <br><br>

    <button id="getRoute">üöó Get Route</button>

    <div id="map"></div>

    <h3>üß≠ Step-by-Step Directions</h3>
    <div id="directions"></div>

    <h3>üìú Logs</h3>
    <div id="logs"></div>
  </main>

<script>
const key = "52e25290-c412-4b79-8f13-1c81ad58e97b";
let map = L.map('map').setView([14.5995, 120.9842], 12);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 19,
}).addTo(map);

let routeLayer = null;
let stepMarkers = [];

function logMsg(msg) {
  const logs = document.getElementById('logs');
  const p = document.createElement('div');
  p.textContent = msg;
  logs.appendChild(p);
  logs.scrollTop = logs.scrollHeight;
}

async function geocode(loc) {
  const url = `https://graphhopper.com/api/1/geocode?q=${encodeURIComponent(loc)}&limit=1&key=${key}`;
  const res = await fetch(url);
  const data = await res.json();
  if (data.hits.length > 0) {
    const p = data.hits[0].point;
    return [p.lat, p.lng];
  } else throw new Error("Location not found: " + loc);
}

function decodePolyline(encoded) {
  let points = [];
  let index = 0, lat = 0, lng = 0;
  while (index < encoded.length) {
    let b, shift = 0, result = 0;
    do {
      b = encoded.charCodeAt(index++) - 63;
      result |= (b & 0x1f) << shift;
      shift += 5;
    } while (b >= 0x20);
    let dlat = ((result & 1) ? ~(result >> 1) : (result >> 1));
    lat += dlat;

    shift = 0;
    result = 0;
    do {
      b = encoded.charCodeAt(index++) - 63;
      result |= (b & 0x1f) << shift;
      shift += 5;
    } while (b >= 0x20);
    let dlng = ((result & 1) ? ~(result >> 1) : (result >> 1));
    lng += dlng;

    points.push([lat / 1e5, lng / 1e5]);
  }
  return points;
}

document.getElementById("getRoute").addEventListener("click", async () => {
  const start = document.getElementById("start").value.trim();
  const end = document.getElementById("end").value.trim();
  const vehicle = document.getElementById("vehicle").value;
  const stepMode = document.getElementById("stepMode").checked;
  const directionsDiv = document.getElementById("directions");
  directionsDiv.innerHTML = "";

  if (!start || !end) {
    alert("Please enter both start and destination.");
    return;
  }

  try {
    logMsg("Geocoding locations...");
    const [origLat, origLng] = await geocode(start);
    const [destLat, destLng] = await geocode(end);

    logMsg("Requesting route from GraphHopper...");
    const routeUrl = `https://graphhopper.com/api/1/route?point=${origLat},${origLng}&point=${destLat},${destLng}&vehicle=${vehicle}&locale=en&key=${key}&points_encoded=true`;
    const res = await fetch(routeUrl);
    const data = await res.json();

    if (!data.paths || data.paths.length === 0) {
      logMsg("No route found.");
      return;
    }

    const path = data.paths[0];
    let coords = [];

    if (path.points && path.points.coordinates) {
      coords = path.points.coordinates.map(c => [c[1], c[0]]);
    } else if (path.points_encoded && path.points) {
      coords = decodePolyline(path.points);
    } else if (path.points_encoded && path.points_encoded !== undefined) {
      coords = decodePolyline(path.points_encoded);
    } else {
      throw new Error("Route data invalid.");
    }

    // Clear previous layers
    if (routeLayer) map.removeLayer(routeLayer);
    stepMarkers.forEach(m => map.removeLayer(m));
    stepMarkers = [];

    // Draw main route
    routeLayer = L.polyline(coords, { color: "#0b7a3a", weight: 5 }).addTo(map);
    map.fitBounds(routeLayer.getBounds());

    // Add start and end markers
    const startMarker = L.marker(coords[0]).addTo(map).bindPopup("Start: " + start);
    const endMarker = L.marker(coords[coords.length - 1]).addTo(map).bindPopup("End: " + end);
    stepMarkers.push(startMarker, endMarker);

    logMsg(`Route loaded. Distance: ${(path.distance / 1000).toFixed(2)} km`);

    // Directions display
    const instructions = path.instructions || [];
    instructions.forEach((step, index) => {
      const lower = step.text?.toLowerCase() || "";
      const sym = lower.includes('left') ? '‚¨ÖÔ∏è' :
                  lower.includes('right') ? '‚û°Ô∏è' :
                  lower.includes('continue') ? '‚¨ÜÔ∏è' :
                  lower.includes('roundabout') ? 'üîÑ' :
                  lower.includes('u-turn') ? '‚Ü©Ô∏è' :
                  lower.includes('destination') ? 'üèÅ' : '‚¨ÜÔ∏è';

      const box = document.createElement('div');
      box.className = "direction-box";
      box.innerHTML = `<span style="font-size:1.3em;">${sym}</span>
                       <span style="font-weight:500;">${index + 1}. ${step.text}</span>`;
      directionsDiv.appendChild(box);

      if (stepMode && step.points) {
        box.addEventListener('click', () => {
          document.querySelectorAll('.direction-box').forEach(b => b.classList.remove('active-step'));
          box.classList.add('active-step');

          const p = step.points.coordinates.map(c => [c[1], c[0]]);
          stepMarkers.forEach(m => map.removeLayer(m));
          stepMarkers = [];

          const tempLayer = L.polyline(p, { color: "yellow", weight: 6 }).addTo(map);
          stepMarkers.push(tempLayer);
          map.fitBounds(tempLayer.getBounds());
        });
      }
    });
  } catch (err) {
    console.error(err);
    logMsg("Error: " + err.message);
  }
});
</script>
</body>
</html>
